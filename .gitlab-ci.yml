stages:
  - build
  - test
  - staging
  - release

default:
  tags:
    - docker-build-01

variables:
  OUTPUT_PATH: '$CI_PROJECT_DIR/artifacts'

before_script:
  # Use a local, writable docker config to avoid macOS Keychain
  - export DOCKER_CONFIG="$CI_PROJECT_DIR/.docker"
  - mkdir -p "$DOCKER_CONFIG"
  - printf '{"credsStore":""}\n' > "$DOCKER_CONFIG/config.json"
  - echo "$CI_JOB_TOKEN" | docker login "$CI_REGISTRY" -u gitlab-ci-token --password-stdin


.override_stage:
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    # replace host url in .env file with corresponding url of stage
    - sed -ie "s/XXX_TRAEFIK_HOST_URL_XXX/$TRAEFIK_HOST_URL/g" ./.env
    # override tag names if present
    - sed -ie "s/XXX_CI_COMMIT_TAG_XXX/$CI_COMMIT_TAG/g" ./.env

build_test_image:
  stage: build
  only:
    - dev
    - merge_requests
  script:
    - docker build -f dockerfiles/Dockerfile.test --build-arg UserID=$(id -u) -t git.blvckleg.dev:5050/personal/aandm_backend:test .
    - docker push git.blvckleg.dev:5050/personal/aandm_backend:test:test

test_test_image:
  stage: test
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  needs:
    - build_test_image
  only:
    - dev
    - merge_requests
  script:
    - mkdir artifacts
    - docker run git.blvckleg.dev:5050/personal/aandm_backend:test:test npm run lint
    - docker run -v "$(pwd)"/artifacts:/home/runner/artifacts git.blvckleg.dev:5050/personal/aandm_backend:test:test npm run test
  after_script:
    - docker image rm -f git.blvckleg.dev:5050/personal/aandm_backend:test:test
  artifacts:
    name: 'tests-and-coverage'
    when: on_success
    reports:
      junit:
        - $OUTPUT_PATH/tests/junit-test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: $OUTPUT_PATH/coverage/cobertura-coverage.xml

build_staging_image:
  stage: staging
  only:
    - dev
  needs:
    - test_test_image
  script:
    - docker build -f dockerfiles/Dockerfile -t git.blvckleg.dev:5050/personal/aandm_backend:test:staging .
    - docker push git.blvckleg.dev:5050/personal/aandm_backend:test:staging

build_release_image:
  stage: release
  only:
    - tags
  except:
    - branches
  when: manual
  script:
    - docker build -f dockerfiles/Dockerfile -t git.blvckleg.dev:5050/personal/aandm_backend:test:${CI_COMMIT_TAG} .
    - docker push git.blvckleg.dev:5050/personal/aandm_backend:test:${CI_COMMIT_TAG}
